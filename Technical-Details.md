# Technical Details 

## Electronic Diagram

<p>In this section we will have a look at the internal workings of this solution.
  
Internally, the circuit consists of a buck converter that, when activated by the firmware, stabilizes the voltage of the solar panel at 5 volts. The internal ADC is used to measure the voltage from the solar panel both when the bulk converter is activated and when it is not.

The output of the bulk converter feeds the battery charger circuit, whose charging current is linearly controlled by the Arduino. An MPPT algorithm has been implemented to constantly analyze the relationship between the voltage delivered by the solar panel and the battery charging current.

The firmware also controls the charging and discharging of the battery, ensuring that the battery is not charged above 4.1 volts and disabling the boost converter and USB charger if the battery falls below 3.7 volts. Ensuring that the battery operates within this range significantly increases battery life. </p>

<img src="https://github.com/pisco-de-luz/Social-Project/blob/54976f91e0ab782d7e09ea7e6a8445cef78fc091/images/Electronic-Diagram.png" height="400">

<p>Seven GPIOs are connected to the input of a Darlington array. This array is used to switch the LEDs in each room on and off independently. The 12V voltage is generated by the boost converter and is common to all rooms. 

Each room can have one or more switches and all of them have a small LED to make it easier to locate them when the room is completely dark. There is also a USB charger circuit that is only activated during the day when there is plenty of sun and the battery is fully charged. 

Finally, a serial port has been added to collect statistics and perform small calibrations when necessary.</p> 

## Automatic power management mode.

### How can such a small battery light an entire house for several nights, even in the rainy season. 

<p>The kit has an adaptive system that reduces or increases the intensity of the lighting according to the amount of energy in the battery.

As you can see in the diagram below, on the left side there is an image of the battery showing the actual battery levels from 0% - 100%. In the middle of the diagram, there are colored bands (level 7 - 0) showing that our device is only using the 25% - 90% range of the total battery charge. The graph in blue shows the charge and discharge curve of the battery. Just 3 hours of strong sunlight is enough to fully charge the battery.

The system uses just this range (25% - 90%) because Li-ion batteries have a useful life of about
approximately 500 charge and discharge cycles when fully charged and fully discharged. However, if they are partially charged (<90%) and partially discharged (>30%), they can reach more than 5000 cycles. Taking advantage of this feature, our device has an intelligent system that protects the battery so that it is neither fully charged nor fully discharged.
  
</p>
<img src="https://github.com/pisco-de-luz/Social-Project/blob/82df39c05221619d0ad39d98dbe062227e2facce/images/Progressive-Energy-Saving-System.png" width="750">


### How does it work?

<p> During the night, the discharge process is not linear, i.e. on the first night, there are few restrictions on the use of the lights, allowing a more accentuated discharge and bringing greater lighting comfort to families. If on the following day there is enough sunshine to charge the battery to the maximum level (level 7), the process will be repeated on the following night. However, if it is a very rainy period and the battery cannot be fully charged, the lighting restrictions will be more intense, forcing a greater saving of the battery.

This restriction process is shown on the right side of the diagram, in the blue box.

For each level indicated in the middle (level 7 - 0), there is a group of lamps signaling the restrictions in the rightmost frame. For example, when the battery level is 7, all 7 rooms can be lit at the same time, but only 3 rooms can use the maximum brightness (7), and the other rooms can only use the brightness (5). As the battery level decreases, these restrictions are adjusted. For example, when the battery reaches level 3, only one room can use brightness (6) and only 5 other rooms can use brightness (3).  This progressive system of restrictions minimizes battery depletion and ensures several nights of basic lighting. Even on rainy and cloudy days, the battery is partially charged and a family would hardly be left completely in the dark.</p>

### Other ways to save energy
  
<p>As we will see below, the system has several features designed with two main goals in mind. First, to save as much energy as possible. Second, to adapt the kit during the installation process to better suit the different types of environments and families that will be using it. 

To achieve these two goals, it is clear that we need a mechanism to adjust the light intensity differently for each room. The simplest way to do this would be to use the existing PWM ports on the microcontroller, but unfortunately the ATmega328 has only 6 and 7 would be needed for our system. To work around this problem, a software version of the PWM engine was developed.</p>
    
<p>An important aspect we use to save energy is to take advantage of the fact that the brightness perception of the human eye is much more pronounced in the first lumens that the LED delivers. So our goal is not to try to provide 2000 to 5000 lumens per room (as we normally use in the city), but only something between 50 and 200 lumens.</p>

<img src="https://github.com/pisco-de-luz/Social-Project/blob/b7419de5b0606ab7a908e854ece61a2ae9773518/images/Normalized-human-visual-response.png" width="300">
                                                                                                                                                     
Another mechanism we are using to save energy is to **gradually reduce the brightness** of the room lighting over time. When exposed to darkness, our pupils dilate in a matter of seconds, our cones adapt in 10 minutes, and our rods adapt over a much longer period of time.
<p> <p>In this way we are able to maintain the same level of perceived illumination using less energy.</p>

<img src="https://github.com/pisco-de-luz/Social-Project/blob/b7419de5b0606ab7a908e854ece61a2ae9773518/images/dark-adaptation-curve.gif" width="300">
  
### Features that have been created to make all this possible.

Each channel of the kit, which is used to light each room independently, has some customizable settings.

As you can see in the graph below, the numbers 1 through 7 on the left represent the brightness level over time. And the elapsed time is shown on the horizontal line at the bottom of the graph. 

This graph shows what will happen to the lighting in this room when the lights are turned on. The default setting for this channel is to automatically decrease the brightness every 10 minutes and automatically turn off after 1 hour. 

Because it is very dark in these remote areas, our pupil is usually very dilated. So when we turn on a light, it comes on smoothly and minimizes the inconvenience of a sudden change. Each channel can be individually configured to turn on automatically when it gets dark. This is useful for the resident's orientation when he or she returns to the house after dark. 

<img src="https://github.com/pisco-de-luz/Social-Project/blob/82df39c05221619d0ad39d98dbe062227e2facce/images/Turning-on-any-Light.png" width="600">

In the example above, the light is set to turn on at level 7. This is also configurable on a per channel basis. Note that after 10 minutes, the light level drops to 6 and this reduction occurs every 10 minutes. After one hour, the lights will automatically turn off. 
Note that whenever a light is turned off, even automatically, there is a period of about 20 seconds where it remains at a very low brightness level and starts a cycle of flashing until it is completely turned off. 

These 20 seconds help the resident to move to another room or even to his bed, because in total darkness it is very difficult to move when it turns off immediately. And the number of flashes it gives before turning off indicates the battery level, with 7 flashes indicating that it is fully charged. 

## Cable System
<p>
The cables are one of the most expensive parts of the system. Each channel uses one pair of wires for the switches and another pair of wires for the LED modules. In general, we use about 60 meters of 4-conductor cable per house. 



Another important factor in cable selection is the type of topology used. Since the entire lighting system operates at a maximum voltage of 12V, and the battery and drivers for the LEDs are located in the central module, it was necessary to use a star topology.</p>

<img src="https://github.com/pisco-de-luz/Social-Project/blob/50c5f9b00743de093748a7757f90fce52107ecf3/images/star-topology.jpg" width="100">

<p> So we usually install the main module in the center of the house and run the cables from there to the rooms, interconnecting the necessary switches and LED modules. 

### Choosing the right cable.
  
Depending on the type of wire used, the cost of the entire system can be very high. We evaluated several alternatives based on cost, weight, robustness, and ease of connecting the cables to the various devices such as switches, LED modules, and main modules.
  
After testing several types of electrical and alarm cables available in Brazil, we found that none were adequate for our needs.

Since the LED modules consume a few tens of milliamperes, we decided to open our options to other types of cables that contain 4 conductors (two pairs).

When we started to evaluate the RJ11 cable, we saw that it would be the perfect cable. The cost is much lower than the others, the male and female connectors are very inexpensive, they are robust, have a double protective cover, and finally, with a single crimping tool you can assemble cables of any size you need. 

In the video below you can have a look at how easy the assembly of the cable is.
</p>
<img src="https://github.com/pisco-de-luz/Social-Project/blob/adc07d1d3181ce736366b36c5657cda9cca52696/images/crimpar-cables.gif" width="400">

Below you can see that the main module has 7 RJ11 jacks, one for each channel (room). 

<img src="https://github.com/pisco-de-luz/Social-Project/blob/c6ce6dea242d6489cb8f5b33b719f41825e8ce3f/images/Main-module.jpg" width="400">

<p>You can also see that the LED modules have two connectors and the switches only one. </p>

<img src="https://github.com/pisco-de-luz/Social-Project/blob/c6ce6dea242d6489cb8f5b33b719f41825e8ce3f/images/LED-module.jpg" width="400"> <img src="https://github.com/pisco-de-luz/Social-Project/blob/c6ce6dea242d6489cb8f5b33b719f41825e8ce3f/images/Switch.jpg" height="150">

